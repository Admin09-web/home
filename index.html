<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Calculadora de Intereses por Obligación</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: auto; }
    .obligacion { border: 1px solid #ccc; padding: 15px; border-radius: 10px; margin-bottom: 15px; background: #f9f9f9; }
    label { display: block; font-weight: bold; margin-top: 10px; }
    input { width: 100%; padding: 8px; margin-top: 4px; box-sizing: border-box; }
    button { margin-top: 20px; padding: 10px 20px; font-size: 16px; }
    .resultado { background: #e7f3ff; padding: 10px; margin-top: 10px; border-radius: 6px; }
  </style>
</head>
<body>

  <h2>Formulario de Obligaciones</h2>

  <form id="miFormulario">
    <div id="contenedorObligaciones"></div>
    <button type="button" onclick="agregarObligacion()">Agregar Obligación</button>
    <button type="submit">Enviar Formulario</button>
  </form>

  <script>
    let contadorObligaciones = 0;

    function agregarObligacion() {
      const contenedor = document.getElementById('contenedorObligaciones');
      const index = contadorObligaciones++;
      const hoy = new Date();
      const yyyy = hoy.getFullYear();
      const mm = String(hoy.getMonth() + 1).padStart(2, '0');
      const dd = String(hoy.getDate()).padStart(2, '0');
      const fechaHoy = `${yyyy}-${mm}-${dd}`;

      const div = document.createElement('div');
      div.className = 'obligacion';
      div.innerHTML = `
        <h3>Obligación ${index + 1}</h3>
        <label for="fechaInicio-${index}">Fecha inicial:</label>
        <input type="date" id="fechaInicio-${index}" name="fechaInicio-${index}" required>

        <label for="fechaVencimiento-${index}">Fecha de vencimiento:</label>
        <input type="date" id="fechaVencimiento-${index}" name="fechaVencimiento-${index}" required>

        <label for="fechaActual-${index}">Fecha actual:</label>
        <input type="date" id="fechaActual-${index}" name="fechaActual-${index}" required readonly value="${fechaHoy}">

        <label for="monto-${index}">Monto ($):</label>
        <input type="text" id="monto-${index}" name="monto-${index}" required placeholder="Ej: 1.500.000">

        <label for="interesMensual-${index}">Interés mensual (%):</label>
        <input type="number" id="interesMensual-${index}" name="interesMensual-${index}" step="0.01" required>

        <label for="interesMoraMensual-${index}">Interés mora mensual (%):</label>
        <input type="number" id="interesMoraMensual-${index}" name="interesMoraMensual-${index}" step="0.01" required>

        <div class="resultado" id="resultado-${index}"></div>
      `;
      contenedor.appendChild(div);
    }

    document.getElementById('miFormulario').addEventListener('submit', function (e) {
      e.preventDefault();
      const salarioMinimo = 1423500;
      const limiteIntereses = 40 * salarioMinimo;

      for (let i = 0; i < contadorObligaciones; i++) {
        // Actualizar la fecha actual justo antes del cálculo
        const hoy = new Date();
        const yyyy = hoy.getFullYear();
        const mm = String(hoy.getMonth() + 1).padStart(2, '0');
        const dd = String(hoy.getDate()).padStart(2, '0');
        const fechaHoy = `${yyyy}-${mm}-${dd}`;
        document.getElementById(`fechaActual-${i}`).value = fechaHoy;

        const fechaInicio = new Date(document.getElementById(`fechaInicio-${i}`).value);
        const fechaVencimiento = new Date(document.getElementById(`fechaVencimiento-${i}`).value);
        const fechaActual = new Date(document.getElementById(`fechaActual-${i}`).value);
        const monto = parseFloat(document.getElementById(`monto-${i}`).value.replace(/\./g, '').replace(/,/g, ''));
        const interesMensual = parseFloat(document.getElementById(`interesMensual-${i}`).value) / 100;
        const interesMoraMensual = parseFloat(document.getElementById(`interesMoraMensual-${i}`).value) / 100;

        const unDia = 1000 * 60 * 60 * 24;
        const diasPlazo = Math.max(0, Math.floor((fechaVencimiento - fechaInicio) / unDia));
        const fechaMoraInicio = new Date(fechaVencimiento.getTime() + unDia);
        const diasMora = Math.max(0, Math.floor((fechaActual - fechaMoraInicio) / unDia));

        const interesPlazoValor = monto * interesMensual * (diasPlazo / 30);
        const interesMoraValor = monto * interesMoraMensual * (diasMora / 30);
        const totalIntereses = interesPlazoValor + interesMoraValor;
        const totalPagar = monto + totalIntereses;

        document.getElementById(`resultado-${i}`).innerHTML = `
          <p><strong>Días de plazo:</strong> ${diasPlazo}</p>
          <p><strong>Días en mora:</strong> ${diasMora}</p>
          <p><strong>Interés de plazo:</strong> ${formatoPesos(interesPlazoValor)}</p>
          <p><strong>Interés de mora:</strong> ${formatoPesos(interesMoraValor)}</p>
          <p><strong>Total intereses:</strong> ${formatoPesos(totalIntereses)}</p>
          <p><strong>Total a pagar:</strong> ${formatoPesos(totalPagar)}</p>
          ${totalIntereses > limiteIntereses ? `<p style="color:red"><strong>⚠️ Supera el límite legal de intereses (${formatoPesos(limiteIntereses)})</strong></p>` : ""}
        `;
      }
    });

    function formatoPesos(valor) {
      return valor.toLocaleString('es-CO', { style: 'currency', currency: 'COP' });
    }

    // Formato automático al salir del campo de monto
    document.addEventListener('blur', function (e) {
      if (e.target && e.target.id.startsWith('monto-')) {
        const val = e.target.value.replace(/\./g, '').replace(/,/g, '');
        const num = parseFloat(val);
        if (!isNaN(num)) {
          e.target.value = num.toLocaleString('es-CO');
        }
      }
    }, true);

    // Cargar con una obligación por defecto
    window.addEventListener('DOMContentLoaded', agregarObligacion);
  </script>

</body>
</html>
